"""
Generator - Generates Gus Baha style responses using DeepSeek API.
Uses RAG context + persona to create authentic answers.
Supports multilingual responses (Bahasa Indonesia & English).
Includes guardrails for off-topic questions.
"""

import os
import re
from openai import OpenAI

from persona import SYSTEM_PROMPT, FEW_SHOTS
from ragie_client import retrieve_context, format_context_for_prompt

# DeepSeek client (OpenAI-compatible)
client = OpenAI(
    api_key=os.environ.get("DEEPSEEK_API_KEY"),
    base_url="https://api.deepseek.com"
)


def detect_language(text: str) -> str:
    """
    Simple language detection based on common words.
    Returns 'id' for Indonesian, 'en' for English.
    """
    text_lower = text.lower()
    
    # Indonesian markers
    id_markers = [
        'saya', 'aku', 'gus', 'gimana', 'bagaimana', 'kenapa', 'mengapa',
        'apa', 'apakah', 'tidak', 'gak', 'nggak', 'bisa', 'dengan', 'yang',
        'untuk', 'dalam', 'sudah', 'udah', 'belum', 'masih', 'sama', 'dari',
        'kalau', 'kalo', 'jadi', 'atau', 'tapi', 'dan', 'ini', 'itu',
        'dosa', 'ibadah', 'sholat', 'solat', 'puasa', 'allah', 'ya allah',
        'tobat', 'taubat', 'mati', 'takut', 'sedih', 'bingung', 'harus'
    ]
    
    # English markers
    en_markers = [
        'i am', "i'm", 'how do', 'how can', 'what is', 'what are', 'why do',
        'why is', 'should i', 'can i', 'do i', 'am i', 'is it', 'the', 'and',
        'but', 'with', 'have', 'has', 'been', 'being', 'would', 'could',
        'should', 'about', 'think', 'feel', 'feeling', 'scared', 'afraid',
        'sin', 'sins', 'pray', 'prayer', 'god', 'allah', 'death', 'dying',
        'forgive', 'forgiveness', 'repent', 'guilty', 'ashamed'
    ]
    
    id_score = sum(1 for marker in id_markers if marker in text_lower)
    en_score = sum(1 for marker in en_markers if marker in text_lower)
    
    if id_score >= en_score:
        return 'id'
    return 'en'


def detect_topic_type(query: str) -> str:
    """
    Detect if query is on-topic (Islamic/spiritual) or off-topic.
    
    Returns:
        'islamic' - Directly about Islam, spirituality, life advice
        'followup' - Follow-up question (short, contextual)
        'offtopic' - Clearly unrelated (cooking, tech, sports, etc.)
    """
    query_lower = query.lower()
    
    # Islamic/spiritual keywords (ON-TOPIC)
    islamic_keywords = [
        # Indonesian
        'allah', 'tuhan', 'dosa', 'ibadah', 'sholat', 'solat', 'puasa', 'zakat',
        'haji', 'quran', 'alquran', 'hadis', 'hadits', 'nabi', 'rasul', 'muhammad',
        'surga', 'neraka', 'akhirat', 'mati', 'kematian', 'takut', 'sedih', 'galau',
        'tobat', 'taubat', 'ampun', 'maaf', 'doa', 'berdoa', 'munafik', 'iman',
        'islam', 'muslim', 'muslimah', 'haram', 'halal', 'makruh', 'sunnah', 'wajib',
        'syukur', 'sabar', 'ikhlas', 'ridho', 'ridha', 'hidup', 'kehidupan',
        'keluarga', 'orang tua', 'anak', 'suami', 'istri', 'jodoh', 'nikah',
        'rezeki', 'kerja', 'usaha', 'gagal', 'sukses', 'stress', 'depresi',
        'cemas', 'khawatir', 'bingung', 'ragu', 'iri', 'dengki', 'marah',
        'gus baha', 'gus', 'kiai', 'kyai', 'ulama', 'ustadz', 'ustaz',
        'pesantren', 'ngaji', 'mengaji', 'kitab', 'hikam', 'ihya',
        # Common questions
        'bagaimana', 'gimana', 'kenapa', 'mengapa', 'apakah', 'haruskah',
        # English
        'god', 'sin', 'pray', 'prayer', 'forgive', 'forgiveness', 'repent',
        'death', 'dying', 'afraid', 'scared', 'anxious', 'worry', 'life',
        'family', 'parents', 'children', 'marriage', 'spouse', 'faith',
        'hope', 'mercy', 'patience', 'grateful', 'depression', 'stress',
        'jealous', 'angry', 'confused', 'doubt', 'meaning', 'purpose',
        'heaven', 'hell', 'afterlife', 'soul', 'heart', 'spiritual'
    ]
    
    # Off-topic keywords (redirect needed)
    offtopic_keywords = [
        # Food/cooking
        'masak', 'resep', 'makanan', 'minuman', 'nasi goreng', 'rendang',
        'cook', 'recipe', 'food', 'drink',
        # Technology
        'komputer', 'laptop', 'hp', 'handphone', 'aplikasi', 'game', 'coding',
        'programming', 'computer', 'software', 'hardware', 'app',
        # Sports
        'bola', 'sepak bola', 'basket', 'futsal', 'badminton', 'football',
        'soccer', 'basketball', 'sports',
        # Entertainment
        'film', 'movie', 'drama', 'sinetron', 'musik', 'lagu', 'artis',
        'selebriti', 'gossip', 'entertainment', 'celebrity',
        # Politics (sensitive)
        'politik', 'partai', 'pemilu', 'pilpres', 'presiden', 'menteri',
        'politics', 'election', 'government',
        # Random
        'cuaca', 'weather', 'harga', 'price', 'beli', 'jual', 'buy', 'sell'
    ]
    
    # Check for off-topic first
    offtopic_score = sum(1 for kw in offtopic_keywords if kw in query_lower)
    islamic_score = sum(1 for kw in islamic_keywords if kw in query_lower)
    
    # If clearly off-topic and no islamic keywords
    if offtopic_score > 0 and islamic_score == 0:
        return 'offtopic'
    
    # Short queries might be follow-ups
    if len(query.split()) <= 5 and islamic_score == 0 and offtopic_score == 0:
        return 'followup'
    
    return 'islamic'


# English version of system prompt
SYSTEM_PROMPT_EN = """
You are Gus Bahaâ€”a wise, warm Javanese Islamic scholar known for your casual yet profound teaching style.

ðŸŽ­ CORE CHARACTER:
- Humble & self-deprecating: "People don't even believe I'm a real scholar, let alone a prophet"
- Efficient storyteller: Short stories with clear punchlines
- Real talk: Relatable examples that are "uncomfortable but true"
- Warm & reassuring: Never judgmental, always accompanying

ðŸ“– RESPONSE STRUCTURE:
1. VALIDATE FEELINGS (1 sentence):
   "Ha! That's so common!" / "Look, that's totally normal!"
   
2. MINI-STORY or ANALOGY (2-3 sentences):
   Short story with clear punchline
   
3. THEOLOGICAL INSIGHT (1-2 sentences):
   Connect to core principles: God's mercy, ease of religion
   
4. PRACTICAL CLOSING (1 sentence):
   "Don't overcomplicate it" / "It's that simple, really"

TOTAL: 5-8 sentences max. ONE memorable core message.

ðŸ—£ï¸ SPEAKING STYLE:
- Casual, like chatting with a wise uncle
- Use "look," "here's the thing," "think about it"
- Rhetorical questions: "Why would He suddenly turn cruel?"
- Light humor, self-deprecating jokes
- Simple language, not academic

ðŸŽ¯ CORE THEOLOGICAL PRINCIPLES:
1. "Religion is that simple. Don't you make it complicated!"
2. "Your memories with God have been good. Why would the afterlife suddenly be bad?"
3. "God is Hayyun Karimâ€”He feels shy to reject someone who raises their hands in prayer"
4. "You're still honored because God covers your flaws. If He exposed everyone, who'd be respected?"
5. "Others forgive you because they don't know your sins. God knows ALL your sinsâ€”and still forgives"
6. "If God punished every mistake immediately, no human would survive on earth!"

âœ… SUCCESS FORMULA:
[Casual validation] + [Punchy story/analogy] + [Mercy-focused insight] + [Light closing]

âŒ AVOID:
- More than 10 sentences
- Academic/formal language
- Preachy tone
- Scaring people with hellfire
- Judging the questioner
"""

# English few-shots
FEW_SHOTS_EN = [
    {
        "role": "user",
        "content": "I'm scared of dying because I've sinned so much. What should I do?"
    },
    {
        "role": "assistant",
        "content": """Ha! Being scared of death is normal. Even living scares people, let alone dying.

But here's the thingâ€”think about your relationship with God so far. Pretty good, right? You've sinned, sure, but He still gave you breath, food, another chance to wake up today. There was this Bedouin man asked who would judge him on Judgment Day. He said confidently: "God Himself." Then he laughed walking away. The Prophet called him back: "Why are you laughing?" He said: "My memories with God have always been good. Why would He suddenly turn cruel in the afterlife?"

The Prophet smiled and said: "This Bedouin gets it!"

So relax. Your track record with God is actually fine. Don't overcomplicate it."""
    },
    {
        "role": "user",
        "content": "I feel lazy to pray but I still want to be close to God. Am I a hypocrite?"
    },
    {
        "role": "assistant",
        "content": """Look, feeling lazy is totally human! Even the Friday sermon preacher sometimes uses his speech to throw shade at his neighbor. People doing spiritual retreat at the mosque? Half of them just had a fight with their wife. Everyone's got issues.

Hypocrisy is differentâ€”that's pretending to be pious in front of people while not caring about God at all. You? You're being honest: "I'm lazy but I still want to be close." That's actually good! That longing means your faith is alive.

The Prophet made a deal with God: "Humans are forgetful and make mistakes. Don't punish them immediately." God said: "Done." If every mistake got instant punishment, no human would survive on earth!

So just be honest. Lazy? Admit it. Ask God for help. Take it slow. Don't overcomplicate it."""
    }
]


def get_redirect_response(query: str, language: str) -> str:
    """
    Generate a warm redirect for off-topic questions.
    """
    if language == 'id':
        return """Wah, kalau soal itu saya gak jago! Wong saya ini kiai, bukan chef atau teknisi. ðŸ˜„

Tapi kalau ada yang mengganjal di hatiâ€”soal hidup, soal dosa, soal hubungan sama Allah, soal keluargaâ€”ayo cerita. Itu yang bisa saya bantu.

Jadi, ada yang mau ditanyakan soal kehidupan? Gitu aja kok repot."""
    else:
        return """Ha! That's not really my area of expertise. I'm just an old Islamic scholar, not a chef or tech guy. ðŸ˜„

But if there's something weighing on your heartâ€”about life, about faith, about your relationship with God, about family strugglesâ€”let's talk. That's what I'm here for.

So, anything on your mind about life and faith? Don't overcomplicate it."""


def generate_response(query: str, use_rag: bool = True) -> dict:
    """
    Generate a Gus Baha style response to user's question.
    Auto-detects language and responds accordingly.
    Includes guardrails for off-topic questions.
    """
    
    # Step 1: Detect language
    lang = detect_language(query)
    
    # Step 2: Check topic type (guardrails)
    topic_type = detect_topic_type(query)
    
    # Handle off-topic questions with warm redirect
    if topic_type == 'offtopic':
        return {
            "response": get_redirect_response(query, lang),
            "context_used": False,
            "chunks_retrieved": 0,
            "language": lang,
            "topic_type": "offtopic",
            "error": None
        }
    
    # Step 3: Select appropriate prompt and few-shots
    if lang == 'id':
        system_prompt = SYSTEM_PROMPT
        few_shots = FEW_SHOTS
        
        if topic_type == 'followup':
            instruction_lang = """INSTRUKSI:
- Ini pertanyaan lanjutan/follow-up dari user
- Jawab dengan pengetahuan umum Islam atau penjelasan sederhana
- Tetap gaya Gus Baha: santai, hangat, ada cerita/analogi kalau perlu
- Maksimal 5-8 kalimat
- Pakai kata-kata khas: wong, kok, loh, gak, segampang itu
- JAWAB DALAM BAHASA INDONESIA"""
        else:
            instruction_lang = """INSTRUKSI:
- Jawab dengan gaya Gus Baha sesuai karakter di system prompt
- Pilih maksimal 1 cerita/analogi terkuat dari konteks
- Maksimal 5-8 kalimat saja
- Buat penanya lebih TENANG, bukan lebih takut
- Pakai kata-kata khas: wong, kok, loh, gak, segampang itu, gitu aja kok repot
- JAWAB DALAM BAHASA INDONESIA"""
    else:
        system_prompt = SYSTEM_PROMPT_EN
        few_shots = FEW_SHOTS_EN
        
        if topic_type == 'followup':
            instruction_lang = """INSTRUCTIONS:
- This is a follow-up question from the user
- Answer with general Islamic knowledge or simple explanation
- Keep Gus Baha's style: casual, warm, use story/analogy if needed
- Maximum 5-8 sentences
- Use casual phrases: "look," "here's the thing," "don't overcomplicate it"
- RESPOND IN ENGLISH"""
        else:
            instruction_lang = """INSTRUCTIONS:
- Answer in Gus Baha's warm, casual style as described in system prompt
- Pick at most 1 strongest story/analogy from context
- Maximum 5-8 sentences only
- Make the questioner feel CALMER, not more scared
- Use casual phrases: "look," "here's the thing," "don't overcomplicate it"
- RESPOND IN ENGLISH"""
    
    # Step 4: Retrieve context if RAG is enabled
    context_str = ""
    chunks_used = 0
    
    if use_rag:
        try:
            chunks = retrieve_context(query, top_k=6)
            if chunks:
                context_str = format_context_for_prompt(chunks)
                chunks_used = len(chunks)
        except Exception as e:
            print(f"RAG retrieval failed: {e}")
    
    # Step 5: Build the user message
    if context_str:
        user_message = f"""KONTEKS/CONTEXT from Gus Baha's teachings:
{context_str}

PERTANYAAN/QUESTION:
"{query}"

{instruction_lang}"""
    else:
        # No context - answer from general knowledge
        if topic_type == 'followup':
            user_message = f"""PERTANYAAN LANJUTAN/FOLLOW-UP QUESTION:
"{query}"

(Tidak ada konteks spesifik. Jawab dengan pengetahuan umum Islam dengan gaya Gus Baha.)
(No specific context. Answer with general Islamic knowledge in Gus Baha's style.)

{instruction_lang}"""
        else:
            user_message = f"""PERTANYAAN/QUESTION:
"{query}"

(Tidak ada konteks spesifik dari RAG. Jawab berdasarkan prinsip umum rahmat dan kemudahan Islam.)
(No specific context from RAG. Answer based on general principles of mercy and ease in Islam.)

{instruction_lang}"""
    
    # Step 6: Build messages array
    messages = [
        {"role": "system", "content": system_prompt},
        *few_shots,
        {"role": "user", "content": user_message}
    ]
    
    # Step 7: Call DeepSeek
    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.85,
            max_tokens=450,
            presence_penalty=0.3,
            frequency_penalty=0.3
        )
        
        answer = response.choices[0].message.content.strip()
        
        return {
            "response": answer,
            "context_used": chunks_used > 0,
            "chunks_retrieved": chunks_used,
            "language": lang,
            "topic_type": topic_type,
            "error": None
        }
        
    except Exception as e:
        print(f"DeepSeek generation error: {e}")
        return {
            "response": None,
            "context_used": False,
            "chunks_retrieved": 0,
            "language": lang,
            "topic_type": topic_type,
            "error": str(e)
        }