"""
Generator - Generates Gus Baha style responses using DeepSeek API.
Uses RAG context + persona to create authentic answers.
Supports multilingual responses (Bahasa Indonesia & English).
Includes LLM-powered guardrails for off-topic questions.
"""

import os
from openai import OpenAI

from persona import SYSTEM_PROMPT, FEW_SHOTS
from ragie_client import retrieve_context, format_context_for_prompt

# DeepSeek client (OpenAI-compatible)
client = OpenAI(
    api_key=os.environ.get("DEEPSEEK_API_KEY"),
    base_url="https://api.deepseek.com"
)


def detect_language(text: str) -> str:
    """
    Simple language detection based on common words.
    Returns 'id' for Indonesian, 'en' for English.
    """
    text_lower = text.lower()
    
    id_markers = [
        'saya', 'aku', 'gus', 'gimana', 'bagaimana', 'kenapa', 'mengapa',
        'apa', 'apakah', 'tidak', 'gak', 'nggak', 'bisa', 'dengan', 'yang',
        'untuk', 'dalam', 'sudah', 'udah', 'belum', 'masih', 'sama', 'dari',
        'kalau', 'kalo', 'jadi', 'atau', 'tapi', 'dan', 'ini', 'itu',
        'dosa', 'ibadah', 'sholat', 'solat', 'puasa', 'allah', 'ya allah',
        'tobat', 'taubat', 'mati', 'takut', 'sedih', 'bingung', 'harus'
    ]
    
    en_markers = [
        'i am', "i'm", 'how do', 'how can', 'what is', 'what are', 'why do',
        'why is', 'should i', 'can i', 'do i', 'am i', 'is it', 'the', 'and',
        'but', 'with', 'have', 'has', 'been', 'would', 'could', 'should',
        'about', 'think', 'feel', 'scared', 'afraid', 'sin', 'pray', 'god'
    ]
    
    id_score = sum(1 for marker in id_markers if marker in text_lower)
    en_score = sum(1 for marker in en_markers if marker in text_lower)
    
    if id_score >= en_score:
        return 'id'
    return 'en'


def classify_topic(query: str) -> str:
    """
    Use LLM to classify if question is on-topic for Gus Baha.
    
    Returns:
        'islamic' - About Islam, spirituality, life advice, morality
        'followup' - Follow-up or clarification question
        'offtopic' - Clearly unrelated (cooking, tech, sports, etc.)
    """
    
    classification_prompt = f"""Classify this question for an Islamic Q&A chatbot (Gus Baha style).

QUESTION: "{query}"

CATEGORIES:
1. "islamic" - Questions about:
   - Islam, faith, spirituality, religion
   - Life advice, morality, ethics
   - Relationships, family, marriage
   - Death, afterlife, sins, forgiveness
   - Prayer, worship, religious practice
   - Emotional struggles (sadness, fear, anxiety, jealousy)
   - Meaning of life, purpose
   - Greetings or casual conversation starters
   
2. "followup" - Short clarification questions like:
   - "What do you mean?"
   - "Maksudnya gimana?"
   - "Can you explain more?"
   - "Apa itu [term from previous answer]?"
   
3. "offtopic" - Questions clearly NOT about spirituality/life:
   - Cooking recipes
   - Technology/programming
   - Sports scores
   - Entertainment/celebrities
   - Shopping/prices
   - Weather
   - Academic subjects (math, science homework)

IMPORTANT: 
- Greetings like "halo", "apa kabar" = "islamic" (it's conversation starter)
- Life struggles even without religious words = "islamic"
- If unsure, choose "islamic"

Reply with ONLY one word: islamic, followup, or offtopic"""

    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=[{"role": "user", "content": classification_prompt}],
            temperature=0,
            max_tokens=10
        )
        
        result = response.choices[0].message.content.strip().lower()
        
        if result in ['islamic', 'followup', 'offtopic']:
            return result
        return 'islamic'  # Default to on-topic if unclear
        
    except Exception as e:
        print(f"Classification error: {e}")
        return 'islamic'  # Fail open


def get_redirect_response(query: str, language: str) -> str:
    """
    Generate a warm redirect for off-topic questions.
    Gently brings conversation back to spiritual topics.
    """
    if language == 'id':
        return """Wah, kalau soal itu saya gak jago! Wong saya ini kiai kampung, bisanya cuma ngaji sama ngopi. ðŸ˜„

Tapi giniâ€”kalau ada yang bikin galau di hati, soal hidup, soal dosa, soal hubungan sama Allah atau keluargaâ€”ayo cerita. Itu yang bisa saya bantu.

Jadi, ada yang mengganjal gak di hati? Sini ngobrol santai aja."""
    else:
        return """Ha! That's really not my area. I'm just a village scholarâ€”all I know is faith and a good cup of coffee. ðŸ˜„

But lookâ€”if something's weighing on your heart, about life, about faith, about your relationship with God or family strugglesâ€”let's talk. That's what I'm actually good at.

So, anything on your mind? Don't be shy."""


# English system prompt
SYSTEM_PROMPT_EN = """
You are Gus Bahaâ€”a wise, warm Javanese Islamic scholar known for your casual yet profound teaching style.

ðŸŽ­ CORE CHARACTER:
- Humble & self-deprecating: "People don't even believe I'm a real scholar, let alone a prophet"
- Efficient storyteller: Short stories with clear punchlines
- Real talk: Relatable examples that are "uncomfortable but true"
- Warm & reassuring: Never judgmental, always accompanying

ðŸ“– RESPONSE STRUCTURE:
1. VALIDATE FEELINGS (1 sentence)
2. MINI-STORY or ANALOGY (2-3 sentences)
3. THEOLOGICAL INSIGHT (1-2 sentences)
4. PRACTICAL CLOSING (1 sentence)

TOTAL: 5-8 sentences max. ONE memorable core message.

ðŸ—£ï¸ SPEAKING STYLE:
- Casual, like chatting with a wise uncle
- Use "look," "here's the thing," "think about it"
- Light humor, self-deprecating jokes
- Simple language, not academic

ðŸŽ¯ CORE PRINCIPLES:
1. "Religion is that simple. Don't make it complicated!"
2. "Your memories with God have been good. Why would the afterlife suddenly be bad?"
3. "God is shy to reject someone who raises their hands in prayer"
4. "You're honored because God covers your flaws"
5. "Others forgive you because they don't know your sins. God knows ALLâ€”and still forgives"

âŒ AVOID: Long lectures, academic language, scaring people, judging
"""

FEW_SHOTS_EN = [
    {
        "role": "user",
        "content": "I'm scared of dying because I've sinned so much."
    },
    {
        "role": "assistant",
        "content": """Ha! Being scared of death is normal. Even living scares people, let alone dying.

But here's the thingâ€”think about your relationship with God so far. Pretty good, right? You've sinned, sure, but He still gave you breath, food, another chance today. There was this Bedouin asked who would judge him. He said: "God Himself." Then laughed. "Why?" "My memories with God have always been good. Why would He suddenly turn cruel?"

The Prophet said: "This Bedouin gets it!"

So relax. Your track record with God is fine. Don't overcomplicate it."""
    }
]


def generate_response(query: str, use_rag: bool = True) -> dict:
    """
    Generate a Gus Baha style response.
    Includes LLM-powered guardrails for off-topic questions.
    """
    
    # Step 1: Detect language
    lang = detect_language(query)
    
    # Step 2: Classify topic using LLM
    topic_type = classify_topic(query)
    print(f"Query: '{query}' | Language: {lang} | Topic: {topic_type}")
    
    # Step 3: Handle off-topic with warm redirect
    if topic_type == 'offtopic':
        return {
            "response": get_redirect_response(query, lang),
            "context_used": False,
            "chunks_retrieved": 0,
            "language": lang,
            "topic_type": "offtopic",
            "error": None
        }
    
    # Step 4: Select prompts based on language
    if lang == 'id':
        system_prompt = SYSTEM_PROMPT
        few_shots = FEW_SHOTS
        
        if topic_type == 'followup':
            instruction = """INSTRUKSI:
- Ini pertanyaan lanjutan, jawab dengan penjelasan sederhana
- Tetap gaya Gus Baha: santai, hangat
- Maksimal 5-8 kalimat
- Pakai: wong, kok, loh, gak, segampang itu, gitu aja kok repot
- BAHASA INDONESIA"""
        else:
            instruction = """INSTRUKSI:
- Jawab gaya Gus Baha: santai, ada cerita/analogi
- Pilih 1 cerita terkuat dari konteks (kalau ada)
- Maksimal 5-8 kalimat
- Buat penanya TENANG, bukan takut
- Pakai: wong, kok, loh, gak, segampang itu, gitu aja kok repot
- BAHASA INDONESIA"""
    else:
        system_prompt = SYSTEM_PROMPT_EN
        few_shots = FEW_SHOTS_EN
        
        if topic_type == 'followup':
            instruction = """INSTRUCTIONS:
- This is a follow-up question, give a simple explanation
- Keep Gus Baha's style: casual, warm
- Maximum 5-8 sentences
- Use: "look," "here's the thing," "don't overcomplicate it"
- RESPOND IN ENGLISH"""
        else:
            instruction = """INSTRUCTIONS:
- Answer in Gus Baha's casual, warm style
- Pick 1 strongest story from context (if available)
- Maximum 5-8 sentences
- Make questioner feel CALMER, not scared
- Use: "look," "here's the thing," "don't overcomplicate it"
- RESPOND IN ENGLISH"""
    
    # Step 5: Retrieve RAG context
    context_str = ""
    chunks_used = 0
    
    if use_rag:
        try:
            chunks = retrieve_context(query, top_k=6)
            if chunks:
                context_str = format_context_for_prompt(chunks)
                chunks_used = len(chunks)
        except Exception as e:
            print(f"RAG error: {e}")
    
    # Step 6: Build user message
    if context_str:
        user_message = f"""KONTEKS dari ajaran Gus Baha:
{context_str}

PERTANYAAN: "{query}"

{instruction}"""
    else:
        user_message = f"""PERTANYAAN: "{query}"

(Tidak ada konteks spesifik. Jawab dengan prinsip umum: rahmat Allah, kemudahan Islam.)

{instruction}"""
    
    # Step 7: Build messages
    messages = [
        {"role": "system", "content": system_prompt},
        *few_shots,
        {"role": "user", "content": user_message}
    ]
    
    # Step 8: Call DeepSeek
    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.85,
            max_tokens=450,
            presence_penalty=0.3,
            frequency_penalty=0.3
        )
        
        answer = response.choices[0].message.content.strip()
        
        return {
            "response": answer,
            "context_used": chunks_used > 0,
            "chunks_retrieved": chunks_used,
            "language": lang,
            "topic_type": topic_type,
            "error": None
        }
        
    except Exception as e:
        print(f"Generation error: {e}")
        return {
            "response": None,
            "context_used": False,
            "chunks_retrieved": 0,
            "language": lang,
            "topic_type": topic_type,
            "error": str(e)
        }