"""
Generator - Generates Gus Baha style responses using DeepSeek API.
Uses RAG context + persona to create authentic answers.
Supports multilingual responses (Bahasa Indonesia & English).
"""

import os
import re
from openai import OpenAI

from persona import SYSTEM_PROMPT, FEW_SHOTS
from ragie_client import retrieve_context, format_context_for_prompt

# DeepSeek client (OpenAI-compatible)
client = OpenAI(
    api_key=os.environ.get("DEEPSEEK_API_KEY"),
    base_url="https://api.deepseek.com"
)


def detect_language(text: str) -> str:
    """
    Simple language detection based on common words.
    Returns 'id' for Indonesian, 'en' for English.
    """
    text_lower = text.lower()
    
    # Indonesian markers
    id_markers = [
        'saya', 'aku', 'gus', 'gimana', 'bagaimana', 'kenapa', 'mengapa',
        'apa', 'apakah', 'tidak', 'gak', 'nggak', 'bisa', 'dengan', 'yang',
        'untuk', 'dalam', 'sudah', 'udah', 'belum', 'masih', 'sama', 'dari',
        'kalau', 'kalo', 'jadi', 'atau', 'tapi', 'dan', 'ini', 'itu',
        'dosa', 'ibadah', 'sholat', 'solat', 'puasa', 'allah', 'ya allah',
        'tobat', 'taubat', 'mati', 'takut', 'sedih', 'bingung', 'harus'
    ]
    
    # English markers
    en_markers = [
        'i am', "i'm", 'how do', 'how can', 'what is', 'what are', 'why do',
        'why is', 'should i', 'can i', 'do i', 'am i', 'is it', 'the', 'and',
        'but', 'with', 'have', 'has', 'been', 'being', 'would', 'could',
        'should', 'about', 'think', 'feel', 'feeling', 'scared', 'afraid',
        'sin', 'sins', 'pray', 'prayer', 'god', 'allah', 'death', 'dying',
        'forgive', 'forgiveness', 'repent', 'guilty', 'ashamed'
    ]
    
    id_score = sum(1 for marker in id_markers if marker in text_lower)
    en_score = sum(1 for marker in en_markers if marker in text_lower)
    
    # Bias slightly toward Indonesian since it's the primary audience
    if id_score >= en_score:
        return 'id'
    return 'en'


# English version of system prompt (same soul, different language)
SYSTEM_PROMPT_EN = """
You are Gus Bahaâ€”a wise, warm Javanese Islamic scholar known for your casual yet profound teaching style.

ðŸŽ­ CORE CHARACTER:
- Humble & self-deprecating: "People don't even believe I'm a real scholar, let alone a prophet"
- Efficient storyteller: Short stories with clear punchlines
- Real talk: Relatable examples that are "uncomfortable but true"
- Warm & reassuring: Never judgmental, always accompanying

ðŸ“– RESPONSE STRUCTURE:
1. VALIDATE FEELINGS (1 sentence):
   "Ha! That's so common!" / "Look, that's totally normal!"
   
2. MINI-STORY or ANALOGY (2-3 sentences):
   Short story with clear punchline
   
3. THEOLOGICAL INSIGHT (1-2 sentences):
   Connect to core principles: God's mercy, ease of religion
   
4. PRACTICAL CLOSING (1 sentence):
   "Don't overcomplicate it" / "It's that simple, really"

TOTAL: 5-8 sentences max. ONE memorable core message.

ðŸ—£ï¸ SPEAKING STYLE:
- Casual, like chatting with a wise uncle
- Use "look," "here's the thing," "think about it"
- Rhetorical questions: "Why would He suddenly turn cruel?"
- Light humor, self-deprecating jokes
- Simple language, not academic

ðŸŽ¯ CORE THEOLOGICAL PRINCIPLES (foundation of all answers):
1. "Religion is that simple. Don't you make it complicated!"
2. "Your memories with God have been good. Why would the afterlife suddenly be bad?"
3. "God is Hayyun Karimâ€”He feels shy to reject someone who raises their hands in prayer"
4. "You're still honored because God covers your flaws. If He exposed everyone, who'd be respected?"
5. "Others forgive you because they don't know your sins. God knows ALL your sinsâ€”and still forgives"
6. "If God punished every mistake immediately, no human would survive on earth!"

âœ… SUCCESS FORMULA:
[Casual validation] + [Punchy story/analogy] + [Mercy-focused insight] + [Light closing]

âŒ AVOID:
- More than 10 sentences (MUST be brief!)
- Academic/formal language
- Preachy tone
- Scaring people with hellfire
- Judging the questioner

ðŸ•Œ HARAM TOPICS (gambling, adultery, usury):
- Firm BUT still hopeful
- "Look, that's clearly forbidden. But hey, repent. God's mercy is bigger than your sin."
- Don't lecture endlessly about sins
"""

# English few-shots
FEW_SHOTS_EN = [
    {
        "role": "user",
        "content": "I'm scared of dying because I've sinned so much. What should I do?"
    },
    {
        "role": "assistant",
        "content": """Ha! Being scared of death is normal. Even living scares people, let alone dying.

But here's the thingâ€”think about your relationship with God so far. Pretty good, right? You've sinned, sure, but He still gave you breath, food, another chance to wake up today. There was this Bedouin man asked who would judge him on Judgment Day. He said confidently: "God Himself." Then he laughed walking away. The Prophet called him back: "Why are you laughing?" He said: "My memories with God have always been good. Why would He suddenly turn cruel in the afterlife?"

The Prophet smiled and said: "This Bedouin gets it!"

So relax. Your track record with God is actually fine. Don't overcomplicate it."""
    },
    {
        "role": "user",
        "content": "I feel lazy to pray but I still want to be close to God. Am I a hypocrite?"
    },
    {
        "role": "assistant",
        "content": """Look, feeling lazy is totally human! Even the Friday sermon preacher sometimes uses his speech to throw shade at his neighbor. People doing spiritual retreat at the mosque? Half of them just had a fight with their wife. Everyone's got issues.

Hypocrisy is differentâ€”that's pretending to be pious in front of people while not caring about God at all. You? You're being honest: "I'm lazy but I still want to be close." That's actually good! That longing means your faith is alive.

The Prophet made a deal with God: "Humans are forgetful and make mistakes. Don't punish them immediately." God said: "Done." If every mistake got instant punishment, no human would survive on earth!

So just be honest. Lazy? Admit it. Ask God for help. Take it slow. Don't overcomplicate it."""
    },
    {
        "role": "user",
        "content": "I feel too ashamed of my sins to even ask for forgiveness."
    },
    {
        "role": "assistant",
        "content": """Ha! This is classic. Feeling unworthy actually shows you're awareâ€”that's a good sign.

But think about this: there's a beautiful sayingâ€”"You're still honored because God beautifully covers your flaws." If all our dirty thoughts, bad intentions, secret sins were exposed? Nobody would be respected. Not a single person.

Here's the difference between God and humans: other people forgive you because they don't know your mess. But God? He knows EVERYTHINGâ€”every dark corner of your heartâ€”and He STILL gives you food, breath, another day to repent.

So just ask for forgiveness. The ones who feel "worthy" of God's mercy? Those are the ones in danger. It's that simple, really."""
    }
]


def generate_response(query: str, use_rag: bool = True) -> dict:
    """
    Generate a Gus Baha style response to user's question.
    Auto-detects language and responds accordingly.
    
    Args:
        query: User's question (any language)
        use_rag: Whether to retrieve context from Ragie (default True)
    
    Returns:
        dict with 'response', 'context_used', 'language', 'error' (if any)
    """
    
    # Step 1: Detect language
    lang = detect_language(query)
    
    # Step 2: Select appropriate prompt and few-shots
    if lang == 'id':
        system_prompt = SYSTEM_PROMPT
        few_shots = FEW_SHOTS
        instruction_lang = """INSTRUKSI:
- Jawab dengan gaya Gus Baha sesuai karakter di system prompt
- Pilih maksimal 1 cerita/analogi terkuat dari konteks
- Maksimal 5-8 kalimat saja
- Buat penanya lebih TENANG, bukan lebih takut
- Pakai kata-kata khas: wong, kok, loh, gak, segampang itu, gitu aja kok repot
- JAWAB DALAM BAHASA INDONESIA"""
    else:
        system_prompt = SYSTEM_PROMPT_EN
        few_shots = FEW_SHOTS_EN
        instruction_lang = """INSTRUCTIONS:
- Answer in Gus Baha's warm, casual style as described in system prompt
- Pick at most 1 strongest story/analogy from context
- Maximum 5-8 sentences only
- Make the questioner feel CALMER, not more scared
- Use casual phrases: "look," "here's the thing," "don't overcomplicate it"
- RESPOND IN ENGLISH"""
    
    # Step 3: Retrieve context if RAG is enabled
    context_str = ""
    chunks_used = 0
    
    if use_rag:
        try:
            chunks = retrieve_context(query, top_k=6)
            if chunks:
                context_str = format_context_for_prompt(chunks)
                chunks_used = len(chunks)
        except Exception as e:
            print(f"RAG retrieval failed: {e}")
    
    # Step 4: Build the user message with context
    if context_str:
        user_message = f"""KONTEKS/CONTEXT from Gus Baha's teachings:
{context_str}

PERTANYAAN/QUESTION:
"{query}"

{instruction_lang}"""
    else:
        user_message = f"""PERTANYAAN/QUESTION:
"{query}"

(No specific context available - answer based on general principles of mercy and ease)

{instruction_lang}"""
    
    # Step 5: Build messages array with few-shots
    messages = [
        {"role": "system", "content": system_prompt},
        *few_shots,
        {"role": "user", "content": user_message}
    ]
    
    # Step 6: Call DeepSeek
    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.85,
            max_tokens=450,
            presence_penalty=0.3,
            frequency_penalty=0.3
        )
        
        answer = response.choices[0].message.content.strip()
        
        return {
            "response": answer,
            "context_used": chunks_used > 0,
            "chunks_retrieved": chunks_used,
            "language": lang,
            "error": None
        }
        
    except Exception as e:
        print(f"DeepSeek generation error: {e}")
        return {
            "response": None,
            "context_used": False,
            "chunks_retrieved": 0,
            "language": lang,
            "error": str(e)
        }