def generate_response(query: str, use_rag: bool = True) -> dict:
    """
    Generate Gus Baha response with source citations.
    Does NOT show sources for off-topic redirects.
    """
    
    # Step 1: Detect language
    lang = detect_language(query)
    
    # Step 2: Select prompts
    if lang == 'id':
        system_prompt = SYSTEM_PROMPT
        few_shots = FEW_SHOTS
        instruction = """INSTRUKSI:
- Jawab gaya Gus Baha: santai, hangat, ada cerita
- Maksimal 5-8 kalimat
- Buat penanya TENANG
- Pakai: wong, kok, loh, gak, segampang itu, gitu aja kok repot
- Kalau topik di luar Islam/kehidupan (masak, coding, olahraga, dll) → redirect dengan hangat
- BAHASA INDONESIA"""
    else:
        system_prompt = SYSTEM_PROMPT_EN
        few_shots = FEW_SHOTS_EN
        instruction = """INSTRUCTIONS:
- Answer in Gus Baha's casual warm style
- Maximum 5-8 sentences
- Make questioner feel CALM
- Use: "look," "here's the thing," "don't overcomplicate it"
- If off-topic (cooking, tech, sports, etc) → warmly redirect
- ENGLISH"""
    
    # Step 3: Get RAG context
    chunks = []
    context_str = ""
    sources = []
    
    if use_rag:
        try:
            chunks = retrieve_context(query, top_k=6)
            if chunks:
                context_str = format_context_for_prompt(chunks)
                sources = get_unique_sources(chunks)
        except Exception as e:
            print(f"RAG error: {e}")
    
    # Step 4: Build message
    if context_str:
        user_message = f"""KONTEKS dari Gus Baha:
{context_str}

PERTANYAAN: "{query}"

{instruction}"""
    else:
        user_message = f"""PERTANYAAN: "{query}"

(Tidak ada konteks spesifik)

{instruction}"""
    
    # Step 5: Generate
    messages = [
        {"role": "system", "content": system_prompt},
        *few_shots,
        {"role": "user", "content": user_message}
    ]
    
    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.85,
            max_tokens=400,
            presence_penalty=0.3,
            frequency_penalty=0.3
        )
        
        answer = response.choices[0].message.content.strip()
        
        # Step 6: Detect if response is a redirect (off-topic)
        # If the answer contains redirect phrases, don't show sources
        redirect_phrases_id = [
            "saya gak pinter",
            "saya gak ngerti", 
            "saya gak jago",
            "bisanya cuma ngaji",
            "kiai kampung",
            "bukan keahlian saya",
            "di luar kemampuan"
        ]
        redirect_phrases_en = [
            "not my thing",
            "not my area",
            "just a village scholar",
            "coffee and faith",
            "not really my expertise"
        ]
        
        answer_lower = answer.lower()
        is_redirect = any(phrase in answer_lower for phrase in redirect_phrases_id + redirect_phrases_en)
        
        # If it's a redirect, don't return sources
        if is_redirect:
            return {
                "response": answer,
                "context_used": False,
                "chunks_retrieved": 0,
                "sources": [],  # No sources for redirects
                "language": lang,
                "error": None
            }
        
        return {
            "response": answer,
            "context_used": len(chunks) > 0,
            "chunks_retrieved": len(chunks),
            "sources": sources,
            "language": lang,
            "error": None
        }
        
    except Exception as e:
        print(f"Generation error: {e}")
        return {
            "response": None,
            "context_used": False,
            "chunks_retrieved": 0,
            "sources": [],
            "language": lang,
            "error": str(e)
        }
```

---

**After pasting, test again:**
```
Gus, gimana cara masak rendang?