/**
 * Gus Baha Chatbot - Frontend Logic
 * Handles chat interactions with mobile-first UX
 */

// DOM Elements
const chatArea = document.getElementById('chatArea');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');

// State
let isLoading = false;

/**
 * Add a message to the chat area
 */
function addMessage(text, type = 'bot') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    // Handle line breaks in text
    contentDiv.innerHTML = text.replace(/\n/g, '<br>');
    
    messageDiv.appendChild(contentDiv);
    chatArea.appendChild(messageDiv);
    
    // Scroll to bottom smoothly
    scrollToBottom();
    
    return messageDiv;
}

/**
 * Show loading indicator
 */
function showLoading() {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot-message loading-message';
    messageDiv.id = 'loadingMessage';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = `
        <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <span style="margin-left: 8px;">Sedang berpikir...</span>
    `;
    
    messageDiv.appendChild(contentDiv);
    chatArea.appendChild(messageDiv);
    scrollToBottom();
}

/**
 * Hide loading indicator
 */
function hideLoading() {
    const loadingMsg = document.getElementById('loadingMessage');
    if (loadingMsg) {
        loadingMsg.remove();
    }
}

/**
 * Scroll chat to bottom
 */
function scrollToBottom() {
    requestAnimationFrame(() => {
        chatArea.scrollTop = chatArea.scrollHeight;
    });
}

/**
 * Auto-resize textarea based on content
 */
function autoResize() {
    userInput.style.height = 'auto';
    userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
}

/**
 * Send message to backend
 */
async function sendMessage() {
    const message = userInput.value.trim();
    
    if (!message || isLoading) return;
    
    // Add user message to chat
    addMessage(message, 'user');
    
    // Clear input and reset height
    userInput.value = '';
    userInput.style.height = 'auto';
    
    // Set loading state
    isLoading = true;
    sendBtn.disabled = true;
    showLoading();
    
    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message }),
        });
        
        const data = await response.json();
        
        hideLoading();
        
        if (data.success && data.response) {
            addMessage(data.response, 'bot');
        } else {
            const errorMsg = data.error || 'Maaf, ada gangguan. Coba lagi ya.';
            addMessage(errorMsg, 'error');
        }
        
    } catch (error) {
        console.error('Chat error:', error);
        hideLoading();
        addMessage('Maaf, koneksi terputus. Coba lagi ya.', 'error');
    } finally {
        isLoading = false;
        sendBtn.disabled = false;
        userInput.focus();
    }
}

/**
 * Handle Enter key (send) and Shift+Enter (new line)
 */
function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

// Event Listeners
sendBtn.addEventListener('click', sendMessage);
userInput.addEventListener('keydown', handleKeyDown);
userInput.addEventListener('input', autoResize);

// Focus input on load (desktop only)
if (window.innerWidth >= 640) {
    userInput.focus();
}

// Prevent zoom on double-tap (iOS)
let lastTouchEnd = 0;
document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
        e.preventDefault();
    }
    lastTouchEnd = now;
}, false);