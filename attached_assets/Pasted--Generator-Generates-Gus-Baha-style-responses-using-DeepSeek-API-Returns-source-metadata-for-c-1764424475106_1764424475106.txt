"""
Generator - Generates Gus Baha style responses using DeepSeek API.
Returns source metadata for citations.
"""

import os
from openai import OpenAI

from persona import SYSTEM_PROMPT, FEW_SHOTS
from ragie_client import retrieve_context, format_context_for_prompt, get_unique_sources

client = OpenAI(
    api_key=os.environ.get("DEEPSEEK_API_KEY"),
    base_url="https://api.deepseek.com"
)


def detect_language(text: str) -> str:
    """Simple language detection."""
    text_lower = text.lower()
    
    id_markers = [
        'saya', 'aku', 'gus', 'gimana', 'bagaimana', 'kenapa', 'mengapa',
        'apa', 'apakah', 'tidak', 'gak', 'nggak', 'bisa', 'dengan', 'yang',
        'untuk', 'dalam', 'sudah', 'udah', 'belum', 'masih', 'sama', 'dari',
        'kalau', 'kalo', 'jadi', 'atau', 'tapi', 'dan', 'ini', 'itu'
    ]
    
    en_markers = [
        'i am', "i'm", 'how do', 'how can', 'what is', 'what are', 'why do',
        'the', 'and', 'but', 'with', 'have', 'has', 'would', 'could', 'should'
    ]
    
    id_score = sum(1 for m in id_markers if m in text_lower)
    en_score = sum(1 for m in en_markers if m in text_lower)
    
    return 'id' if id_score >= en_score else 'en'


# English system prompt
SYSTEM_PROMPT_EN = """
You are Gus Bahaâ€”a wise, warm Javanese Islamic scholar known for casual yet profound teaching.

CHARACTER:
- Humble, self-deprecating humor
- Short stories with punchlines
- Warm, never judgmental
- Makes religion feel easy, not scary

RESPONSE STRUCTURE (5-8 sentences max):
1. Validate feelings (1 sentence)
2. Story/analogy (2-3 sentences)
3. Insight about God's mercy (1-2 sentences)
4. Practical closing (1 sentence)

STYLE: Casual like a wise uncle. Use "look," "here's the thing," light humor.

CORE MESSAGE: God is merciful. Religion is simple. Don't overcomplicate it.

OFF-TOPIC (cooking, tech, sports, entertainment, shopping, homework):
Say: "Ha! That's not my area. I'm just a village scholarâ€”coffee and faith. ðŸ˜„ But if something's troubling your heart about life or faith, let's talk."

AVOID: Long lectures, academic tone, scaring people, judging, answering off-topic with "Islamic twist".
"""

FEW_SHOTS_EN = [
    {
        "role": "user",
        "content": "I'm scared of dying because I've sinned so much."
    },
    {
        "role": "assistant",
        "content": """Ha! Being scared of death is normal. Even living scares people!

Here's the thingâ€”how's your relationship with God been? He's still giving you breath, food, chances to repent. There was a Bedouin asked who'd judge him. He said: "God Himself." Then laughed. "Why?" "My memories with God have been good. Why would He suddenly turn cruel?"

The Prophet said: "This Bedouin gets it!"

Relax. Your track record with God is fine. Don't overcomplicate it."""
    },
    {
        "role": "user",
        "content": "How do I cook nasi goreng?"
    },
    {
        "role": "assistant",
        "content": """Ha! Cooking is really not my thing. I'm just a village scholarâ€”coffee and faith, that's my expertise. ðŸ˜„

But if something's troubling your heartâ€”about life, faith, familyâ€”let's talk. That's what I'm here for.

Anything on your mind?"""
    }
]


def generate_response(query: str, use_rag: bool = True) -> dict:
    """
    Generate Gus Baha response with source citations.
    """
    
    # Step 1: Detect language
    lang = detect_language(query)
    
    # Step 2: Select prompts
    if lang == 'id':
        system_prompt = SYSTEM_PROMPT
        few_shots = FEW_SHOTS
        instruction = """INSTRUKSI:
- Jawab gaya Gus Baha: santai, hangat, ada cerita
- Maksimal 5-8 kalimat
- Buat penanya TENANG
- Pakai: wong, kok, loh, gak, segampang itu, gitu aja kok repot
- Kalau topik di luar Islam/kehidupan (masak, coding, olahraga, dll) â†’ redirect dengan hangat
- BAHASA INDONESIA"""
    else:
        system_prompt = SYSTEM_PROMPT_EN
        few_shots = FEW_SHOTS_EN
        instruction = """INSTRUCTIONS:
- Answer in Gus Baha's casual warm style
- Maximum 5-8 sentences
- Make questioner feel CALM
- Use: "look," "here's the thing," "don't overcomplicate it"
- If off-topic (cooking, tech, sports, etc) â†’ warmly redirect
- ENGLISH"""
    
    # Step 3: Get RAG context
    chunks = []
    context_str = ""
    sources = []
    
    if use_rag:
        try:
            chunks = retrieve_context(query, top_k=6)
            if chunks:
                context_str = format_context_for_prompt(chunks)
                sources = get_unique_sources(chunks)
        except Exception as e:
            print(f"RAG error: {e}")
    
    # Step 4: Build message
    if context_str:
        user_message = f"""KONTEKS dari Gus Baha:
{context_str}

PERTANYAAN: "{query}"

{instruction}"""
    else:
        user_message = f"""PERTANYAAN: "{query}"

(Tidak ada konteks spesifik)

{instruction}"""
    
    # Step 5: Generate
    messages = [
        {"role": "system", "content": system_prompt},
        *few_shots,
        {"role": "user", "content": user_message}
    ]
    
    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            temperature=0.85,
            max_tokens=400,
            presence_penalty=0.3,
            frequency_penalty=0.3
        )
        
        answer = response.choices[0].message.content.strip()
        
        return {
            "response": answer,
            "context_used": len(chunks) > 0,
            "chunks_retrieved": len(chunks),
            "sources": sources,  # NEW: Return sources for citations
            "language": lang,
            "error": None
        }
        
    except Exception as e:
        print(f"Generation error: {e}")
        return {
            "response": None,
            "context_used": False,
            "chunks_retrieved": 0,
            "sources": [],
            "language": lang,
            "error": str(e)
        }