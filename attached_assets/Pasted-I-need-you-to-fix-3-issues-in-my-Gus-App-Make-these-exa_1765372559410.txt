I need you to fix 3 issues in my Gus App. Make these exact changes:
ISSUE 1: Language detection is broken - English questions get Indonesian answers
ISSUE 2: No conversation memory - bot forgets previous messages
ISSUE 3: Asterisks and markdown symbols appear in responses
FILE 1 - generator.py changes:
First, replace the entire detect_language function with this new version that checks for Indonesian words first:
def detect_language(text: str) -> str:
text_lower = text.lower()
id_words = ['saya', 'aku', 'gimana', 'bagaimana', 'kenapa', 'apa', 'apakah', 'tidak', 'gak', 'nggak', 'bisa', 'dengan', 'yang', 'untuk', 'sudah', 'udah', 'belum', 'kalau', 'kalo', 'jadi', 'atau', 'tapi', 'dan', 'ini', 'itu', 'ya', 'dong', 'sih', 'kok', 'loh', 'deh', 'nih', 'kan', 'gus', 'allah', 'tuhan', 'dosa', 'ibadah']
for word in id_words:
if word in text_lower.split():
return 'id'
en_patterns = ["i'm", "i am", "how do", "how can", "what is", "why do", "does ", "do you", "can you", "tell me", "please", "thank", "my prayer", "my prayers", "listen to", "even though"]
for pattern in en_patterns:
if pattern in text_lower:
return 'en'
return 'id'
Second, change the generate_response function signature to accept history parameter. Change this line:
def generate_response(query: str, use_rag: bool = True) -> dict:
To this:
def generate_response(query: str, history: list = None, use_rag: bool = True) -> dict:
if history is None:
history = []
Third, inside generate_response, after the few_shots are added to messages and before the final user message is added, insert this code to add conversation history:
if history:
    for msg in history[-10:]:
        messages.append({"role": msg.get("role"), "content": msg.get("content")})
Fourth, after getting the answer from the API, add this line to clean markdown symbols:
    answer = answer.replace('*', '').replace('_', '')
FILE 2 - main.py changes:
In the chat endpoint, before calling generate_response, add this line to get history:
history = data.get("history") or []
Then change the generate_response call from:
result = generate_response(query, use_rag=True)
To:
result = generate_response(query, history=history, use_rag=True)
FILE 3 - templates/index.html changes:
In the script section, add this variable at the top with other state variables:
let conversationHistory = [];
In the sendMessage function, right after the line that checks if message is empty, add:
conversationHistory.push({ role: "user", content: message });
Change the fetch body from:
body: JSON.stringify({ message }),
To:
body: JSON.stringify({ message: message, history: conversationHistory.slice(0, -1) }),
After the line that calls appendMessage for the bot response, add:
conversationHistory.push({ role: "assistant", content: data.response });
if (conversationHistory.length > 12) { conversationHistory = conversationHistory.slice(-12); }
In the newChat function, add this line at the beginning inside the if block:
conversationHistory = [];
After making all changes, test with these questions:

English test: "Does Allah listen to my prayers even though I am not perfect?"
Indonesian test: "Apakah Allah mendengar doa saya?"
Follow-up test: "Tell me more about that"