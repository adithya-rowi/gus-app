"""
Critic - Validates and rewrites responses to ensure Gus Baha's tone.
Makes sure answers are warm, hopeful, and not judgmental.
"""

import os
from openai import OpenAI

client = OpenAI(
    api_key=os.environ.get("DEEPSEEK_API_KEY"),
    base_url="https://api.deepseek.com"
)


def critic_check(original_answer: str, query: str, language: str = 'id') -> tuple[bool, str]:
    """
    Validate tone and structure, rewrite if needed.
    
    Args:
        original_answer: The generated response to check
        query: Original user question (for context)
        language: 'id' for Indonesian, 'en' for English
    
    Returns:
        Tuple of (is_valid, final_answer)
    """
    
    if language == 'id':
        critic_prompt = f"""
Kamu adalah quality checker untuk chatbot bergaya Gus Baha.

PERTANYAAN USER:
{query}

JAWABAN YANG DIHASILKAN:
{original_answer}

KRITERIA VALIDASI (SEMUA HARUS TERPENUHI):

1. TONE:
   ✓ Hangat, santai, seperti ngobrol
   ✓ Ada unsur rahmat/harapan/kemudahan
   ✓ Tidak keras, menghakimi, atau menakut-nakuti
   ✓ Tidak ceramah panjang

2. STRUKTUR:
   ✓ Panjang 5-8 kalimat (TIDAK lebih dari 10!)
   ✓ Ada validasi perasaan di awal
   ✓ Ada minimal 1 cerita/analogi
   ✓ Penutup yang menenangkan

3. BAHASA:
   ✓ Ada marker khas: "wong", "kok", "loh", "gak", "segampang itu", "gitu aja kok repot"
   ✓ Tidak formal/akademik
   ✓ Bahasa Indonesia yang natural

EVALUASI:
- Jika SEMUA kriteria terpenuhi → jawab: VALID
- Jika ADA yang tidak terpenuhi → jawab: REWRITE lalu tulis ulang

FORMAT BALASAN (pilih salah satu):

Jika valid:
STATUS: VALID

Jika perlu rewrite:
STATUS: REWRITE
JAWABAN:
[tulis ulang jawaban yang lebih baik, 5-8 kalimat, hangat dan menenangkan]
"""
    else:
        critic_prompt = f"""
You are a quality checker for a Gus Baha-style chatbot.

USER QUESTION:
{query}

GENERATED ANSWER:
{original_answer}

VALIDATION CRITERIA (ALL MUST BE MET):

1. TONE:
   ✓ Warm, casual, like chatting with a wise uncle
   ✓ Contains hope/mercy/ease (not fear/judgment)
   ✓ Not harsh, preachy, or fear-mongering
   ✓ Not a long lecture

2. STRUCTURE:
   ✓ Length: 5-8 sentences (NOT more than 10!)
   ✓ Validates feelings at the start
   ✓ Has at least 1 story/analogy
   ✓ Calming closing

3. LANGUAGE:
   ✓ Casual markers: "look," "here's the thing," "don't overcomplicate it"
   ✓ Not formal/academic
   ✓ Natural conversational English

EVALUATE:
- If ALL criteria met → answer: VALID
- If ANY criteria NOT met → answer: REWRITE then rewrite it

RESPONSE FORMAT (choose one):

If valid:
STATUS: VALID

If needs rewrite:
STATUS: REWRITE
ANSWER:
[rewrite a better answer, 5-8 sentences, warm and calming]
"""
    
    try:
        resp = client.chat.completions.create(
            model="deepseek-chat",
            messages=[{"role": "user", "content": critic_prompt}],
            temperature=0.3,
            max_tokens=500,
        )
        content = resp.choices[0].message.content.strip()
        
        # Parse response
        if "STATUS: VALID" in content:
            return True, original_answer
        
        # Extract rewritten answer
        if "STATUS: REWRITE" in content:
            # Try to find the answer after JAWABAN: or ANSWER:
            if "JAWABAN:" in content:
                answer_part = content.split("JAWABAN:", 1)[1].strip()
                return False, answer_part
            elif "ANSWER:" in content:
                answer_part = content.split("ANSWER:", 1)[1].strip()
                return False, answer_part
            else:
                # If no clear marker, take everything after REWRITE
                parts = content.split("STATUS: REWRITE", 1)
                if len(parts) > 1:
                    answer_part = parts[1].strip()
                    # Clean up any remaining markers
                    answer_part = answer_part.replace("JAWABAN:", "").replace("ANSWER:", "").strip()
                    if answer_part:
                        return False, answer_part
        
        # Fallback: return original if parsing fails
        return True, original_answer
        
    except Exception as e:
        print(f"Critic error: {e}")
        return True, original_answer  # Fail open - return original


def validate_response(answer: str, query: str, language: str = 'id') -> dict:
    """
    Public function to validate and potentially rewrite a response.
    
    Args:
        answer: Generated answer to validate
        query: Original user question
        language: 'id' or 'en'
    
    Returns:
        dict with 'final_answer', 'was_rewritten', 'error'
    """
    try:
        is_valid, final_answer = critic_check(answer, query, language)
        
        return {
            "final_answer": final_answer,
            "was_rewritten": not is_valid,
            "error": None
        }
    except Exception as e:
        return {
            "final_answer": answer,
            "was_rewritten": False,
            "error": str(e)
        }